<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketplace Calculator V2.5.1</title>
    
    <style>
    * { box-sizing: border-box; }
    body { margin: 0 !important; padding: 0 !important; width: 100%; overflow-x: hidden; }
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    .calculator-container {
        font-family: Arial, sans-serif;
        background-color: #ffffff;
        padding: 30px;
        border-radius: 12px;
        width: 100%; 
        max-width: 450px;
        margin: auto;
    }

    p:last-of-type { margin-bottom: 0 !important; padding-bottom: 0 !important; }
    .version-tag { text-align: center; color: #6c757d; font-size: 0.9em; margin-top: -20px; margin-bottom: 25px; }
    h2 { color: #333; text-align: center; margin-bottom: 30px; }
    .input-group { margin-bottom: 25px; }
    .input-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #000000; font-size: 1em; }
    .input-row { display: flex; align-items: center; gap: 10px; }
    .calculator-input { padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1em; }
    #modalPrice, #otherCost, #actualPrice { width: 100%; }
    .percentage-input { width: 80px; text-align: right; font-weight: bold; }

    .slider-input {
        flex-grow: 1; height: 10px; -webkit-appearance: none; background: #e0e0e0; border-radius: 5px; cursor: pointer;
    }
    .slider-input::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #4CAF50; cursor: pointer; border: 3px solid #fff; box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
    }
    .slider-min-max { font-size: 0.8em; color: #999; margin-top: 5px; text-align: left; }

    .action-button {
        width: 100%; padding: 12px; background-color: #4CAF50; color: white; font-size: 1.1em; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease; margin-top: 15px;
    }
    .action-button:hover { background-color: #45a049; }
    .action-button:disabled { background-color: #ccc; cursor: not-allowed; }

    hr { border: 0; height: 1px; background: #eee; margin: 20px 0; }
    .detailed-breakdown { margin-top: 15px; padding: 10px; border: 1px solid #f0f0f0; border-radius: 8px; background-color: #f9f9f9; }
    .detail-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 1em; border-bottom: 1px dashed #eee; }
    .detail-row:last-child { border-bottom: none; }
    .result-header { padding: 10px 0; border-bottom: 2px solid #4CAF50; margin-bottom: 10px; }
    .result-header span { font-weight: bold; }
    .result-header strong { color: #4CAF50; line-height: 1.2; }
    .profit-row { padding-top: 10px; border-top: 1px solid #ddd; }
    .profit-row span { font-weight: bold; }
    .profit-row strong { color: #FF9800; line-height: 1.2; }

    .roas-table-container { width: 100%; margin-top: 0px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background-color: #ffffff; }
    .roas-header-title { font-weight: bold; color: #ffffff; font-size: 1.1em; padding: 12px; text-align: center; border-bottom: 1px solid #ffffff; margin: 0; background-color: #4CAF50; }
    .roas-table { width: 100%; border-collapse: collapse; font-size: 0.85em; background-color: #ffffff; table-layout: fixed; }
    .roas-table thead tr:first-child th:nth-child(1) { width: 14%; } 
    .roas-table thead tr:first-child th:nth-child(2) { width: 23%; } 
    .roas-table thead tr:first-child th:last-child { width: 32%; } 
    .roas-table thead th { background-color: #F9F9F9; color: #000000; font-weight: bold; font-size: 0.85em; padding: 8px 3px; text-align: center; border-bottom: 1px solid #E0E0E0; border-right: 1px solid #E0E0E0; white-space: nowrap; }
    .roas-table th, .roas-table td { border-bottom: 1px solid #E0E0E0; border-right: 1px solid #E0E0E0; font-size: 0.85em; padding: 8px 3px; }
    .roas-table th:last-child, .roas-table td:last-child { border-right: none; }
    .roas-table thead tr:nth-child(2) th:last-child { border-right: 1px solid #E0E0E0; }
    .roas-table tbody tr:last-child td { border-bottom: none; }
    .roas-table td { text-align: center; }
    .roas-table td:last-child { text-align: left; padding-left: 8px; }
    .target-row { background-color: #e8f5e9; font-weight: bold; } 
    .bep-row { background-color: #FFF6AC; font-weight: bold; } 
    .roas-profit-positive { color: #28a745; font-weight: bold; }
    .roas-profit-negative { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

<div id="main-container" class="calculator-container">
    <h2>Marketplace Calculator</h2>
    <p class="version-tag">Versi 2.5.1 by Steven Alexander</p>
    <hr>
    
    <div class="input-group">
        <label for="modalPrice">Harga Modal (Rp)</label>
        <div class="input-row">
            <input type="text" inputmode="numeric" id="modalPrice" class="calculator-input" value="100.000">
        </div>
    </div>
    
    <div class="input-group slider-group">
        <label for="mpFeeRate">Biaya Layanan Marketplace (%)</label>
        <div class="input-row">
            <input type="range" id="mpFeeRateSlider" class="calculator-input slider-input" min="0" max="50" step="0.5" value="15">
            <input type="number" id="mpFeeRate" class="calculator-input percentage-input" value="15" min="0" max="100">
        </div>
        <p class="slider-min-max">Min: 0% | Max: 50%</p>
        <p class="slider-min-max">Total Biaya Layanan, Extra Ongkir, Promo, Dll Dari Marketplace</p>
    </div>
    
    <div class="input-group slider-group">
        <label for="adsBudgetRate">Biaya Iklan / Ads (%)</label>
        <div class="input-row">
            <input type="range" id="adsBudgetRateSlider" class="calculator-input slider-input" min="0" max="50" step="0.5" value="10">
            <input type="number" id="adsBudgetRate" class="calculator-input percentage-input" value="10" min="0" max="100">
        </div>
        <p class="slider-min-max">Min: 0% | Max: 50%</p>
        <p class="slider-min-max">Alokasi Budget Marketplace / Meta / TikTok Ads</p>
    </div>
    
    <div class="input-group slider-group">
        <label for="affiliateBudgetRate">Biaya Komisi Affiliator (%)</label>
        <div class="input-row">
            <input type="range" id="affiliateBudgetRateSlider" class="calculator-input slider-input" min="0" max="50" step="0.5" value="5">
            <input type="number" id="affiliateBudgetRate" class="calculator-input percentage-input" value="5" min="0" max="100">
        </div>
        <p class="slider-min-max">Min: 0% | Max: 50%</p>
        <p class="slider-min-max">Alokasi Komisi Affiliator Setiap Produk Terjual</p>
    </div>
    
    <div class="input-group slider-group">
        <label for="operationalBudgetRate">Biaya Operasional (%)</label>
        <div class="input-row">
            <input type="range" id="operationalBudgetRateSlider" class="calculator-input slider-input" min="0" max="50" step="0.5" value="5">
            <input type="number" id="operationalBudgetRate" class="calculator-input percentage-input" value="5" min="0" max="100">
        </div>
        <p class="slider-min-max">Min: 0% | Max: 50%</p>
        <p class="slider-min-max">Alokasi Biaya Operasional : Gaji Karyawan, Sewa Tempat, Dll</p>
    </div>

    <div class="input-group">
        <label for="otherCost">Biaya Lainnya (Rp)</label>
        <div class="input-row">
            <input type="text" inputmode="numeric" id="otherCost" class="calculator-input" value="0">
        </div>
        <p></p>
        <p class="slider-min-max">Input Nominal Biaya Secara Manual</p>
        <p class="slider-min-max">Contoh: Biaya Proses Order (Rp 1.250), Packing, dll</p>

    </div>

    <div class="input-group slider-group">
        <label for="profitMarginRate">Profit Margin / Keuntungan (%)</label>
        <div class="input-row">
            <input type="range" id="profitMarginRateSlider" class="calculator-input slider-input" min="0" max="50" step="0.5" value="15">
            <input type="number" id="profitMarginRate" class="calculator-input percentage-input" value="15" min="0" max="100">
        </div>
        <p class="slider-min-max">Min: 0% | Max: 50%</p>
        <p class="slider-min-max">Tentukan Profit Yang Diinginkan, Dihitung Dari Harga Jual</p>
    </div>

    <div class="input-group">
        <label for="actualPrice">Harga Jual Aktual (Rp)</label>
        <div class="input-row">
            <input type="text" inputmode="numeric" id="actualPrice" class="calculator-input" value="0">
        </div>
        <p></p>
        <p class="slider-min-max">Input Nominal Harga Jual Secara Manual</p>
        <p class="slider-min-max">Kosongkan Apabila Ingin Hitung Harga Jual Minimal</p>

    </div>
    
    <hr>
    
    <div class="input-group">
        <label>Total Persentase Biaya & Profit (Max 100%)</label>
        <div class="input-row" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; background-color: #f0f8ff;">
            <strong id="totalVariableOutput" style="color: #4CAF50; flex-grow: 1; text-align: center;">0.0%</strong>
        </div>
    </div>
    
    <hr>
    <button id="calculateButton" class="action-button">Kalkulasi</button>
    <hr>
    
    <div class="detailed-breakdown">
        <div class="detail-row result-header">
            <span id="sellingPriceLabel">Harga Jual Minimal</span>
            <strong id="minSellingPriceOutput">Rp 0</strong>
        </div>
        <div class="detail-row">
            <span>Biaya Layanan Marketplace</span>
            <strong id="mpFeeAmountOutput">Rp 0</strong>
        </div>
        <div class="detail-row">
            <span>Biaya Iklan / Ads</span>
            <strong id="adsAmountOutput">Rp 0</strong>
        </div>
        <div class="detail-row">
            <span>Biaya Komisi Affiliator</span>
            <strong id="affiliateAmountOutput">Rp 0</strong>
        </div>
        <div class="detail-row">
            <span>Biaya Operasional</span>
            <strong id="operationalAmountOutput">Rp 0</strong>
        </div>
        <div class="detail-row">
            <span>Biaya Lainnya</span>
            <strong id="otherCostOutput">Rp 0</strong>
        </div>
        <div class="detail-row" style="border-bottom: none;">
            <span>Harga Modal</span>
            <strong id="modalPriceOutput">Rp 0</strong>
        </div>
        <div class="detail-row profit-row">
            <span>Profit Margin / Keuntungan</span>
            <strong id="profitAmountOutput">Rp 0</strong>
        </div>
    </div>

    <hr style="border: 0; height: 1px; background: #eee; margin: 20px 0;">

    <div id="roasBreakdownContainer" class="roas-table-container" style="display: none;">
        <div class="roas-header-title">Simulasi Performa ROAS</div>
        <table class="roas-table">
            <thead>
                <tr>
                    <th rowspan="2">ROAS</th>
                    <th rowspan="2">CPA / CPP</th>
                    <th colspan="2">Profit Bersih</th>
                    <th rowspan="2">Status</th>
                </tr>
                <tr>
                    <th>IDR</th>
                    <th>P&L</th>
                </tr>
            </thead>
            <tbody id="roasTableBody"></tbody>
        </table>
    </div>
</div>
</body>

<script>
    // --- RESIZE SYSTEM (Solusi Stabil dari Jastip Calculator) ---
    const FRAME_ID = 'marketplace-calculator-widget'; // ID harus sama dengan Taplink Headscript
    
    function getAccurateHeight() {
        const container = document.getElementById('main-container');
        if(container) {
            // Mengukur tinggi container utama + buffer aman 30px
            return container.offsetHeight + 30; 
        }
        return document.body.scrollHeight + 30;
    }

    function sendHeight() {
        const h = getAccurateHeight();
        window.parent.postMessage({ height: h, frameId: FRAME_ID }, '*');
    }

    function triggerResizeSequence() {
        sendHeight();
        // Burst signals untuk menangkap perubahan ketinggian
        setTimeout(sendHeight, 20);
        setTimeout(sendHeight, 50);
        setTimeout(sendHeight, 100);
        setTimeout(sendHeight, 300);
        setTimeout(sendHeight, 500); 
    }

    // --- HELPER FUNCTIONS ---
    function formatCurrency(number) {
        if (isNaN(number) || number === null || number === undefined) { return 'Rp 0'; }
        const roundedNumber = Math.round(number);
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(roundedNumber);
    }
    
    function formatNumber(number) {
        if (isNaN(number) || number === null || number === undefined) { return '0'; }
        const roundedNumber = Math.round(number);
        return new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0 }).format(roundedNumber);
    }

    function formatInputNumber(inputElement) {
        let value = inputElement.value.replace(/\./g, '').replace(/,/g, ''); 
        if (value) {
            const numberValue = parseInt(value, 10);
            inputElement.value = new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0 }).format(numberValue);
        } else {
            inputElement.value = '';
        }
    }

    function getRawValue(elementId) {
        const input = document.getElementById(elementId);
        return parseFloat(input?.value.replace(/\./g, '').replace(/,/g, '')) || 0;
    }

    function updateTotalVariable() {
        const mpFee = parseFloat(document.getElementById('mpFeeRate')?.value) || 0;
        const adsBudget = parseFloat(document.getElementById('adsBudgetRate')?.value) || 0;
        const affiliateBudget = parseFloat(document.getElementById('affiliateBudgetRate')?.value) || 0;
        const operationalBudget = parseFloat(document.getElementById('operationalBudgetRate')?.value) || 0;
        const profitMargin = parseFloat(document.getElementById('profitMarginRate')?.value) || 0;

        const totalRate = mpFee + adsBudget + affiliateBudget + operationalBudget + profitMargin;
        const totalOutput = document.getElementById('totalVariableOutput');
        const calculateButton = document.getElementById('calculateButton');
        
        if (totalOutput) {
            totalOutput.textContent = `${totalRate.toFixed(1)}%`;
            const bgColor = totalRate >= 100 ? '#d32f2f' : '#4CAF50';
            const textContent = totalRate >= 100 ? 'ERROR! Total Persentase Melebihi 100%' : 'Kalkulasi';

            totalOutput.style.color = bgColor;
            if (calculateButton) { 
                calculateButton.disabled = totalRate >= 100; 
                calculateButton.textContent = textContent; 
                calculateButton.style.backgroundColor = bgColor; 
            }
        }
    }
    
    function calculateMarketplacePrice() {
        const modalPrice = getRawValue('modalPrice');
        const otherCost = getRawValue('otherCost');
        const actualPriceInput = getRawValue('actualPrice'); 
        
        const mpFeeRate = parseFloat(document.getElementById('mpFeeRate')?.value) / 100 || 0;
        const adsBudgetRate = parseFloat(document.getElementById('adsBudgetRate')?.value) / 100 || 0;
        const affiliateBudgetRate = parseFloat(document.getElementById('affiliateBudgetRate')?.value) / 100 || 0; 
        const operationalBudgetRate = parseFloat(document.getElementById('operationalBudgetRate')?.value) / 100 || 0;
        const profitMarginRate = parseFloat(document.getElementById('profitMarginRate')?.value) / 100 || 0;

        const elements = ['minSellingPriceOutput', 'sellingPriceLabel', 'profitAmountOutput', 'mpFeeAmountOutput', 'adsAmountOutput', 'affiliateAmountOutput', 'operationalAmountOutput', 'otherCostOutput', 'modalPriceOutput', 'roasBreakdownContainer', 'calculateButton'];
        const outputs = elements.reduce((acc, id) => ({ ...acc, [id]: document.getElementById(id) }), {});
        
        if (!outputs.minSellingPriceOutput || !outputs.roasBreakdownContainer) return; 
        
        const totalRateFraction = mpFeeRate + adsBudgetRate + affiliateBudgetRate + operationalBudgetRate + profitMarginRate;

        if (totalRateFraction >= 1) {
            outputs.minSellingPriceOutput.textContent = "ERROR!";
            outputs.roasBreakdownContainer.style.display = 'none'; 
            return;
        }

        const calculatedMinPrice = modalPrice / (1 - totalRateFraction);
        let finalSellingPrice = actualPriceInput > 0 ? actualPriceInput : calculatedMinPrice;

        outputs.sellingPriceLabel.textContent = actualPriceInput > 0 ? "Harga Jual Aktual" : "Harga Jual Minimal";

        const mpFeeAmount = finalSellingPrice * mpFeeRate;
        const adsAmount = finalSellingPrice * adsBudgetRate;
        const affiliateAmount = finalSellingPrice * affiliateBudgetRate;
        const operationalAmount = finalSellingPrice * operationalBudgetRate;
        
        const totalVariableCosts = mpFeeAmount + adsAmount + affiliateAmount + operationalAmount;
        const profitAmount = finalSellingPrice - modalPrice - otherCost - totalVariableCosts;

        if (profitAmount < -1 && outputs.calculateButton) {
            outputs.calculateButton.textContent = "ERROR! Total Profit Margin < 0";
            outputs.calculateButton.style.backgroundColor = "#d32f2f";
        } else if (outputs.calculateButton) {
            outputs.calculateButton.textContent = "Kalkulasi";
            outputs.calculateButton.style.backgroundColor = "#4CAF50";
        }

        outputs.minSellingPriceOutput.textContent = formatCurrency(finalSellingPrice);
        outputs.profitAmountOutput.textContent = formatCurrency(profitAmount);
        outputs.mpFeeAmountOutput.textContent = formatCurrency(mpFeeAmount);
        outputs.adsAmountOutput.textContent = formatCurrency(adsAmount);
        outputs.affiliateAmountOutput.textContent = formatCurrency(affiliateAmount);
        outputs.operationalAmountOutput.textContent = formatCurrency(operationalAmount);
        outputs.otherCostOutput.textContent = formatCurrency(otherCost);
        outputs.modalPriceOutput.textContent = formatCurrency(modalPrice);
        
        const variableNonAds = mpFeeAmount + affiliateAmount + operationalAmount;
        const totalFixedAndNonAds = modalPrice + otherCost + variableNonAds;

        generateRoasSimulation(finalSellingPrice, totalFixedAndNonAds);
        
        triggerResizeSequence(); 
    }
    
    function generateRoasSimulation(sellingPrice, totalFixedAndNonAds) {
        
        const maxAdsBudgetBEP = sellingPrice - totalFixedAndNonAds;
        const roasBEP = maxAdsBudgetBEP > 0 ? sellingPrice / maxAdsBudgetBEP : 0; 
        
        const initialAdsRate = parseFloat(document.getElementById('adsBudgetRate')?.value) / 100 || 0;
        const plannedAdsBudget = sellingPrice * initialAdsRate; 
        
        const roasTarget = plannedAdsBudget > 0 ? (sellingPrice / plannedAdsBudget) : (roasBEP > 0 ? roasBEP * 2 : 0); 

        const scenarios = [
            { roas: roasTarget, statusLabel: 'Target Tercapai', rowClass: 'target-row' },
            { roas: roasBEP > 0 ? roasBEP + ((roasTarget - roasBEP) / 2) : 0, statusLabel: 'Untung Rendah', rowClass: '' },
            { roas: roasBEP, statusLabel: 'BEP', rowClass: 'bep-row' },
            { roas: roasBEP * 0.8, statusLabel: 'Rugi Rendah', rowClass: '' },
            { roas: roasBEP * 0.5, statusLabel: 'Rugi Parah', rowClass: '' }
        ];

        const roasTableBody = document.getElementById('roasTableBody');
        roasTableBody.innerHTML = ''; 
        
        scenarios.forEach(item => {
            const currentRoas = item.roas;
            if (currentRoas <= 0) return; 

            const adsActual = sellingPrice / currentRoas;
            
            const profitActual = sellingPrice - totalFixedAndNonAds - adsActual;
            const profitPercentage = (profitActual / sellingPrice) * 100;
            
            const profitColorClass = profitActual >= -50 ? 'roas-profit-positive' : 'roas-profit-negative'; 
            
            let profitSign = '';
            if (profitActual > 50) profitSign = '+'; 
            
            let displayRoas = currentRoas >= 10 ? currentRoas.toFixed(0) : currentRoas.toFixed(1);
            if (displayRoas.endsWith('.0')) displayRoas = displayRoas.slice(0, -2);

            const row = roasTableBody.insertRow();
            row.className = item.rowClass;

            row.innerHTML = `
                <td>${displayRoas}</td>
                <td>${formatNumber(adsActual)}</td>
                <td class="${profitColorClass}">${formatNumber(profitActual)}</td>
                <td class="${profitColorClass}">${profitSign}${profitPercentage.toFixed(1)}%</td>
                <td>${item.statusLabel}</td>
            `;
        });
        document.getElementById('roasBreakdownContainer').style.display = 'block';
    }

    function setupSliderSync(sliderId, numberId) {
        const slider = document.getElementById(sliderId);
        const numberInput = document.getElementById(numberId);
        if (slider && numberInput) {
            slider.addEventListener('input', () => { numberInput.value = slider.value; updateTotalVariable(); });
            numberInput.addEventListener('input', () => {
                let val = parseFloat(numberInput.value);
                const max = parseFloat(slider.max);
                const min = parseFloat(slider.min);
                if (val > max) { val = max; numberInput.value = max; } 
                else if (val < min) { val = min; numberInput.value = min; }
                slider.value = val;
                updateTotalVariable();
            });
            numberInput.value = slider.value;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const inputs = ['modalPrice', 'otherCost', 'actualPrice'];
        inputs.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('input', function() { formatInputNumber(this); });
                formatInputNumber(el);
            }
        });

        setupSliderSync('mpFeeRateSlider', 'mpFeeRate');
        setupSliderSync('adsBudgetRateSlider', 'adsBudgetRate');
        setupSliderSync('affiliateBudgetRateSlider', 'affiliateBudgetRate'); 
        setupSliderSync('operationalBudgetRateSlider', 'operationalBudgetRate');
        setupSliderSync('profitMarginRateSlider', 'profitMarginRate');
        
        const calculateButton = document.getElementById('calculateButton');
        if (calculateButton) {
            calculateButton.addEventListener('click', calculateMarketplacePrice);
        }
        
        const observer = new ResizeObserver(() => triggerResizeSequence());
        const container = document.getElementById('main-container');
        if(container) observer.observe(container);
        
        document.addEventListener('click', triggerResizeSequence);

        updateTotalVariable();
        calculateMarketplacePrice(); 
        triggerResizeSequence(); 
    });
</script>
</html>
